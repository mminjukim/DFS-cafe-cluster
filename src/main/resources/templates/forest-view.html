<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì„±ë¶êµ¬ ì¹´í˜ ê±°ë¦¬ ë¶„ì„</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<header>
    <h1>DFSë¥¼ ì´ìš©í•œ ì„±ë¶êµ¬ ì¹´í˜ ê±°ë¦¬ ë¶„ì„</h1>
    <p class="subtitle">ì»´í“¨í„°í•™ì „ê³µ 20230774 ê¹€ë¯¼ì£¼ / DFS ì—°ê²° ìš”ì†Œ(Connected Components) êµ°ì§‘í™” ë¶„ì„</p>
</header>

<div class="controls">
    <form action="/" method="get" id="filterForm">
        <label for="distanceRange">êµ°ì§‘ ì—°ê²° ê±°ë¦¬ ì„¤ì • (ë°˜ê²½)</label>

        <div class="range-wrap">
            <input type="range" id="distanceRange" name="distance"
                   min="10" max="100" step="10"
                   th:value="${currentDistance}"
                   oninput="document.getElementById('rangeVal').innerText = this.value + 'm'"
                   onchange="document.getElementById('filterForm').submit()">

            <span id="rangeVal" class="range-value" th:text="${currentDistance} + 'm'">50m</span>
        </div>

        <p style="font-size: 0.85rem; color: #8d6e63; margin-top: 10px;">
            ìŠ¬ë¼ì´ë”ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì¹´í˜ ê°„ ì—°ê²° ì„ê³„ê°’ì„ ì¡°ì ˆí•˜ì„¸ìš”.
        </p>
    </form>
</div>

<div class="stats">
    í˜„ì¬ ì„ê³„ê°’: <span th:text="${currentDistance} + 'm'">50m</span> |
    ë°œê²¬ëœ ì¹´í˜ êµ°ì§‘: <span th:text="${totalClusters}">0</span>ê°œ
</div>

<div class="container">
    <div class="card" th:each="cluster, stat : ${clusters}">
        <div class="cluster-header">
            <div style="display: flex; align-items: center;">
                <span class="cluster-id" th:text="'ì¹´í˜ êµ°ì§‘ #' + ${stat.count}">ì¹´í˜ êµ°ì§‘ #1</span>

                <span class="badge-hot" th:if="${cluster.size() >= 12}">
                    ğŸ”¥ í•«í”Œë ˆì´ìŠ¤
                </span>
            </div>
            <span class="cluster-size" th:text="${cluster.size()} + 'ê³³'">5ê³³</span>
        </div>

        <ul class="shop-list">
            <li th:each="shop : ${cluster}">
                <span class="shop-name" th:text="${shop.name}">ìŠ¤íƒ€ë²…ìŠ¤ ì„±ë¶ì </span>
                <span class="shop-addr" th:text="${shop.address}">ì„œìš¸ì‹œ ì„±ë¶êµ¬ ...</span>
            </li>
        </ul>

        <div class="card-footer">
            <button class="btn-find-center"
                    onclick="findCenter(this)"
                    th:data-shop-ids="${cluster.![id]}">
                <span>ğŸ” ì¹´í˜ ê±°ë¦¬ ë‚´ ì¤‘ì‹¬ ì¹´í˜ ì°¾ê¸°</span>
            </button>
            <div class="center-result-box"></div>
        </div>
    </div>
</div>

<script>
    async function findCenter(button) {
        const resultBox = button.nextElementSibling;
        const shopIdsStr = button.getAttribute('data-shop-ids');
        const shopIds = JSON.parse(shopIdsStr);

        // ë¡œë”© ìƒíƒœ ë³€ê²½
        button.innerHTML = '<span>â³ ê³„ì‚° ì¤‘...</span>';
        button.classList.add('loading');
        button.disabled = true;

        try {
            // ì„œë²„ ìš”ì²­
            const response = await fetch('/api/analysis/center', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(shopIds) // ID ë¦¬ìŠ¤íŠ¸ ì „ì†¡
            });

            if (!response.ok) throw new Error("Network response was not ok");

            const centerShop = await response.json(); // ì‘ë‹µ CoffeeShop ê°ì²´

            // ê²°ê³¼ í‘œì‹œ
            resultBox.style.display = 'block';
            resultBox.innerHTML = `
                <span class="center-badge">ğŸ‘‘ CENTER</span>
                ${centerShop.name}
            `;

            button.innerHTML = '<span>âœ… ë¶„ì„ ì™„ë£Œ</span>';

        } catch (error) {
            console.error('Error:', error);
            button.innerHTML = '<span>âš ï¸ ì˜¤ë¥˜ ë°œìƒ</span>';
            button.disabled = false;
            button.classList.remove('loading');
            alert('ì¤‘ì‹¬ ì¹´í˜ë¥¼ ì°¾ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
</script>

</body>
</html>